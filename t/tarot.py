
#from langchain_core.documents import 
from dotenv import load_dotenv,find_dotenv
import os 
from langchain_openai import ChatOpenAI
from langchain_community.embeddings import BaichuanTextEmbeddings
from langchain_chroma import Chroma
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.runnables import RunnablePassthrough
from langchain_core.prompts import MessagesPlaceholder
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_core.chat_history import BaseChatMessageHistory
from langchain_community.chat_message_histories import ChatMessageHistory
import time
from langchain.chains import create_history_aware_retriever,create_retrieval_chain
from langchain.chains.combine_documents import create_stuff_documents_chain
import random
import secrets

store = {}
def get_session_history(session_id:str) -> BaseChatMessageHistory:
    if session_id not in store:
        store[session_id] = ChatMessageHistory()
    return store[session_id]

documents=[
{"id":0, "page_content":"正位解释: 新的开始，自发性，冒险，逆位解释: 鲁莽，天真，错误决策，总解释: 愚者代表着冒险、接受未知和开始新的旅程。正立位置表示天真和自发性。反立位置则表示愚蠢或缺乏远见。", "source":"愚者"},
{"id":1, "page_content":"正位解释: 实现，技巧，自信，逆位解释: 诡计，操纵，不安全感，总解释: 魔术师代表着足智多谋、创造力和行动。正立位置表示技巧和掌握。反立位置则表示欺诈或缺乏自信。", "source":"魔术师"},
{"id":2, "page_content":"正位解释: 直觉，秘密，神秘，逆位解释: 隐藏动机，超然，困惑，总解释: 女祭司代表直觉、内在智慧和宇宙的奥秘。正立位置表示秘密或隐藏的知识。反立位置则表示困惑或与直觉的联系缺失。", "source":"女祭司"},
{"id":3, "page_content":"正位解释: 培育，丰富，创造力，逆位解释: 依赖，缺乏成长，忽视，总解释: 女皇代表母性、丰富和创造性表达。正立位置表示培育和成长。反立位置则表示依赖或忽视。", "source":"女皇"},
{"id":4, "page_content":"正位解释: 权威，结构，稳定，逆位解释: 统治，僵化，滥用权力，总解释: 皇帝代表权威、结构和稳定。正立位置表示领导和保护。反立位置则表示统治或滥用权力。", "source":"皇帝"},
{"id":5, "page_content":"正位解释: 传统，顺从，导师，逆位解释: 教条主义，叛逆，非传统信仰，总解释: 教皇代表传统、顺从和导师。正立位置表示遵循传统或寻求指导。反立位置则表示叛逆或非传统信仰。", "source":"教皇"},
{"id":6, "page_content":"正位解释: 爱情，和谐，选择，逆位解释: 不和谐，分离，犹豫不决，总解释: 恋人代表爱情、和谐和选择。正立位置表示伴侣关系和和谐。反立位置则表示不和谐或犹豫不决。", "source":"恋人"},
{"id":7, "page_content":"正位解释: 掌控，决心，成功，逆位解释: 失控，侵略，失败，总解释: 战车代表掌控、决心和成功。正立位置表示克服障碍和实现目标。反立位置则表示失控或侵略。", "source":"战车"},
{"id":8, "page_content":"正位解释: 内在力量，勇气，同情心，逆位解释: 软弱，自我怀疑，缺乏自律，总解释: 力量代表内在力量、勇气和同情心。正立位置表示面对恐惧和克服障碍。反立位置则表示软弱或自我怀疑。", "source":"力量"},
{"id":9, "page_content":"正位解释: 孤独，内省，智慧，逆位解释: 孤立，孤独，退缩，总解释: 隐者代表孤独、内省和智慧。正立位置表示追求知识和理解。反立位置则表示孤立或退缩。", "source":"隐者"},
{"id":10, "page_content":"正位解释: 循环，命运，变化，逆位解释: 厄运，停滞，失控，总解释: 命运之轮代表循环、命运和变化。正立位置表示好运和积极的变化。反立位置则表示厄运或停滞。", "source":"命运之轮"},
{"id":11, "page_content":"正位解释: 平衡，公正，真相，逆位解释: 不公，偏见，不诚实，总解释: 正义代表平衡、公正和真相。正立位置表示法律事务或需要公正。反立位置则表示不公或不诚实。", "source":"正义"},
{"id":12, "page_content":"正位解释: 投降，牺牲，放手，逆位解释: 停顿，犹豫，抵抗，总解释: 倒吊人代表投降、牺牲和放手。正立位置表示需要耐心或改变观点。反立位置则表示停顿或对改变的抵抗。", "source":"倒吊人"},
{"id":13, "page_content":"正位解释: 转变，变化，重生，逆位解释: 对改变的抵抗，停滞，腐朽，总解释: 死神代表转变、变化和重生。正立位置表示一个循环的结束和另一个循环的开始。反立位置则表示对改变的抵抗或停滞。", "source":"死神"},
{"id":14, "page_content":"正位解释: 平衡，和谐，适度，逆位解释: 不平衡，过度，自我安慰，总解释: 节制代表平衡、和谐和适度。正立位置表示找到中立地带或避免极端。反立位置则表示不平衡或过度行为。", "source":"节制"},
{"id":15, "page_content":"正位解释: 物质主义，上瘾，诱惑，逆位解释: 自由，解脱，战胜负面模式，总解释: 恶魔代表物质主义、上瘾和诱惑。正立位置表示负面模式或依附。反立位置则表示从这些模式中获得自由或解脱。", "source":"恶魔"},
{"id":16, "page_content":"正位解释: 突然的动荡，混乱，启示，逆位解释: 灾难，动荡，回避改变，总解释: 塔代表突然的动荡、混乱和启示。正立位置表示重大变革或启示。反立位置则表示回避必要的变革或灾难。", "source":"塔"},
{"id":17, "page_content":"正位解释: 希望，启发，清晰，逆位解释: 幻灭，气馁，信念缺失，总解释: 星星代表希望、启发和清晰。正立位置表示找到目标或方向。反立位置则表示幻灭或缺乏信念。", "source":"星星"},
{"id":18, "page_content":"正位解释: 直觉，神秘，幻象，逆位解释: 困惑，恐惧，欺骗，总解释: 月亮代表直觉、神秘和幻象。正立位置表示倾听内心的声音或追随一条不明确的道路。反立位置则表示困惑或欺骗。", "source":"月亮"},
{"id":19, "page_content":"正位解释: 活力，成功，幸福，逆位解释: 傲慢，过于自信，缺乏成就，总解释: 太阳代表活力、成功和幸福。正立位置表示成就感或喜悦。反立位置则表示傲慢或缺乏成就。", "source":"太阳"},
{"id":20, "page_content":"正位解释: 重生，更新，觉醒，逆位解释: 缺乏自我意识，自我怀疑，自我批评，总解释: 审判代表重生、更新和觉醒。正立位置表示新的开始或行动的呼唤。反立位置则表示缺乏自我意识或自我怀疑。", "source":"审判"},
{"id":21, "page_content":"正位解释: 完成，实现，完整，逆位解释: 不完整，缺乏结局，缺乏方向，总解释: 世界代表完成、实现和完整。正立位置表示达到目标或实现一种完整感。反立位置则表示缺乏结局或缺乏方向。", "source":"世界"},
{"id":22, "page_content":"正位解释: 灵感，新的开始，潜力，逆位解释: 缺乏方向，延迟，错失机会，总解释: 权杖王牌是开始新事物的灵感之火。正立时，它象征着潜力和新的开始，而反立则可能暗示延迟或缺乏方向。", "source":"权杖王牌"},
{"id":23, "page_content":"正位解释: 规划，合作伙伴关系，进展，逆位解释: 缺乏规划，延迟，意外障碍，总解释: 权杖二代表规划和合作伙伴关系。正立时，它暗示进展和团队合作，而反立则可能表示意外障碍或缺乏规划。", "source":"权杖二"},
{"id":24, "page_content":"正位解释: 扩张，远见，准备，逆位解释: 缺乏远见，延迟，错失机会，总解释: 权杖三代表扩张和远见。正立时，它暗示着为成功做准备和预期，而反立则可能表示错失机会或缺乏远见。", "source":"权杖三"},
{"id":25, "page_content":"正位解释: 庆祝，和谐，家庭，逆位解释: 中断，冲突，不稳定，总解释: 权杖四代表家庭中的庆祝和和谐。正立时，它暗示着稳定和幸福，而反立则可能表示冲突或不稳定。", "source":"权杖四"},
{"id":26, "page_content":"正位解释: 竞争，挑战，多样性，逆位解释: 回避，团结，合作，总解释: 权杖五代表竞争和挑战。正立时，它暗示着多样性和成长，而反立则可能表示需要团结和合作以克服挑战。", "source":"权杖五"},
{"id":27, "page_content":"正位解释: 胜利，认可，进展，逆位解释: 挫折，缺乏认可，自我，总解释: 权杖六代表胜利和认可。正立时，它暗示着进展和成就，而反立则可能表示挫折、缺乏认可或自我问题。", "source":"权杖六"},
{"id":28, "page_content":"正位解释: 防御，毅力，挑战，逆位解释: 放弃，投降，脆弱，总解释: 权杖七代表防御和毅力。正立时，它暗示勇气面对挑战，而反立则可能表示放弃或脆弱。", "source":"权杖七"},
{"id":29, "page_content":"正位解释: 运动，速度，变化，逆位解释: 延迟，挫折，沟通不畅，总解释: 权杖八代表运动和速度。正立时，它暗示着进展和变化，而反立则可能表示延迟、挫折或沟通不畅。", "source":"权杖八"},
{"id":30, "page_content":"正位解释: 坚韧，毅力，勇气，逆位解释: 倦怠，精疲力竭，放弃，总解释: 权杖九代表坚韧和毅力。正立时，它暗示着在挑战面前坚持不懈的勇气，而反立则可能表示倦怠、精疲力竭或放弃。", "source":"权杖九"},
{"id":31, "page_content":"正位解释: 负担，责任，努力工作，逆位解释: 不堪重负，压力，精疲力竭，总解释: 权杖十代表负担和责任。正立时，它暗示着努力工作和承受重压的能力，而反立则可能表示不堪重负、压力或精疲力竭。", "source":"权杖十"},
{"id":32, "page_content":"正位解释: 探索，热情，发现，逆位解释: 缺乏方向，拖延，延迟，总解释: 权杖侍从代表探索和热情。正立时，它暗示着发现和冒险的感觉，而反立则可能表示缺乏方向、拖延或延迟。", "source":"权杖侍从"},
{"id":33, "page_content":"正位解释: 行动，激情，冒险，逆位解释: 草率决策，鲁莽，不耐烦，总解释: 权杖骑士代表行动、激情和冒险。正立时，它暗示着大胆行动，无畏追求自己的激情。然而，当它反立时，可能表示草率的决策、鲁莽和不耐烦，提醒您放慢脚步，考虑行动的后果。", "source":"权杖骑士"},
{"id":34, "page_content":"正位解释: 勇气，决心，魅力，逆位解释: 冲动，喜怒无常，苛求，总解释: 权杖皇后代表勇气、决心和魅力。正立时，它暗示着一个自信而充满活力的个体，对自己的目标充满激情，并愿意冒险去实现它们。然而，当它反立时，可能表示冲动、喜怒无常或对他人苛求，提醒您保持平衡，关注自我照顾，并与周围的人明确而尊重地沟通。", "source":"权杖皇后"},
{"id":35, "page_content":"正位解释: 领导力，远见，创造力，逆位解释: 傲慢，冲动，暴虐，总解释: 权杖国王代表领导力、远见和创造力。正立时，它暗示着一个强大而有魅力的领导者，能以他们的愿景和创造力激励他人。然而，当它反立时，可能表示傲慢、冲动甚至暴虐，提醒您保持谦卑，倾听他人的意见，并以同情和共情的方式领导。", "source":"权杖国王"},
{"id":36, "page_content":"正位解释: 新的开始，情感满足，喜悦，逆位解释: 情感阻塞，空虚，单恋，总解释: 圣杯王牌代表新的开始，情感满足和喜悦。正立时，它暗示着您的杯子中充满了爱和同情。然而，当它反立时，可能表示情感阻塞、空虚或单恋，敦促您疗愈并释放情感包袱。", "source":"圣杯王牌"},
{"id":37, "page_content":"正位解释: 伴侣关系，联系，吸引力，逆位解释: 不平衡，破裂的关系，误解，总解释: 圣杯二代表伴侣关系，联系和吸引力。正立时，它暗示着和谐的关系和相互理解。然而，当它反立时，可能表示不平衡、破裂的关系或误解，提醒您开放和共情地沟通。", "source":"圣杯二"},
{"id":38, "page_content":"正位解释: 庆祝，友谊，社群，逆位解释: 排斥，过度放纵，有害关系，总解释: 圣杯三代表庆祝，友谊和社群。正立时，它暗示着欢乐的聚会和积极的社交关系。然而，当它反立时，可能表示排斥、过度放纵或有害关系，鼓励您寻找健康和支持性的关系。", "source":"圣杯三"},
{"id":39, "page_content":"正位解释: 冥想，思考，冷漠，逆位解释: 无聊，错失机会，不满，总解释: 圣杯四代表冥想，思考和冷漠。正立时，它暗示着内省和内在成长。然而，当它反立时，可能表示无聊、错失机会或不满，敦促您对新的经验和机遇保持开放。", "source":"圣杯四"},
{"id":40, "page_content":"正位解释: 失去，悲伤，失望，逆位解释: 接受，宽恕，继续前进，总解释: 圣杯五代表失去、悲伤和失望。正立时，它暗示着一段哀悼和情感疗愈的时期。然而，当它反立时，可能表示接受、宽恕和继续前进，敦促您放下过去的伤痛，拥抱现在的时刻。", "source":"圣杯五"},
{"id":41, "page_content":"正位解释: 怀旧，天真，慷慨，逆位解释: 过度理想化，活在过去，不切实际的期望，总解释: 圣杯六代表怀旧、天真和慷慨。正立时，它暗示着美好的回忆和童真的好奇心。然而，当它反立时，可能表示过度理想化、活在过去或不切实际的期望，提醒您保持脚踏实地，在现实中培养健康的怀旧情感。", "source":"圣杯六"},
{"id":42, "page_content":"正位解释: 幻想，错觉，选择，逆位解释: 诱惑，困惑，不切实际的期望，总解释: 圣杯七代表幻想、错觉和选择。正立时，它暗示着众多选择和丰富的想象力潜力。然而，当它反立时，可能表示诱惑、困惑或不切实际的期望，警告您专注于自己的目标，避免分散注意力。", "source":"圣杯七"},
{"id":43, "page_content":"正位解释: 过渡，放弃，继续前进，逆位解释: 对改变的恐惧，逃避现实，优柔寡断，总解释: 圣杯八代表过渡、放弃和继续前进。正立时，它暗示着需要改变和成长。然而，当它反立时，可能表示对改变的恐惧、逃避现实或优柔寡断，敦促您面对自己的恐惧，做出艰难的选择。", "source":"圣杯八"},
{"id":44, "page_content":"正位解释: 满足，满意，感激，逆位解释: 傲慢，自以为是，物质主义，总解释: 圣杯九代表满足、满意和感激。正立时，它暗示着一种满足和丰盛的感觉。然而，当它反立时，可能表示傲慢、自以为是或物质主义，提醒您保持谦逊，并培养感恩的态度。", "source":"圣杯九"},
{"id":45, "page_content":"正位解释: 和谐，幸福，爱，逆位解释: 不和谐，脱离联系，破碎的家庭纽带，总解释: 圣杯十代表和谐、幸福和爱。正立时，它暗示着充实和幸福的家庭生活。然而，当它反立时，可能表示不和谐、脱离联系或破碎的家庭纽带，敦促您解决和治愈关系问题。", "source":"圣杯十"},
{"id":46, "page_content":"正位解释: 创造力，直觉，新的开始，逆位解释: 情感不成熟，不切实际的期望，逃避倾向，总解释: 圣杯侍从代表创造力、直觉和新的开始。正立时，它暗示着一种对生活的创造性和情感开放的态度。然而，当它反立时，可能表示情感不成熟、不切实际的期望或逃避倾向，提醒您保持脚踏实地，直面自己的感受。", "source":"圣杯侍从"},
{"id":47, "page_content":"正位解释: 浪漫，魅力，想象力，逆位解释: 情绪化，情感操控，不切实际的期望，总解释: 圣杯骑士代表浪漫、魅力和想象力。正立时，它暗示着对梦想的浪漫和热情的追求。然而，当它反立时，可能表示情绪化、情感操控或不切实际的期望，敦促您在感性和理性之间找到健康平衡。", "source":"圣杯骑士"},
{"id":48, "page_content":"正位解释: 同情心、情感稳定、直觉，逆位解释: 互相依赖、情感操控、过于情绪化，总解释: 圣杯皇后代表同情心、情感稳定和直觉。正位时，它暗示情感成熟和对他人的培育态度。然而，逆位时可能表示互相依赖、情感操控或过于情绪化，提醒你要建立健康的界限并照顾自己的情感幸福。", "source":"圣杯皇后"},
{"id":49, "page_content":"正位解释: 情感平衡、慷慨、外交手腕，逆位解释: 喜怒无常、情感压抑、操控，总解释: 圣杯国王代表情感平衡、慷慨和外交手腕。正位时，它暗示成熟和富有同理心的人际关系处理方式。然而，逆位时可能表示喜怒无常、情感压抑或操控，提醒你要以健康的方式面对并表达自己的感受。", "source":"圣杯国王"},
{"id":50, "page_content":"正位解释: 清晰、突破、思维力量，逆位解释: 困惑、混乱、思维障碍，总解释: 宝剑王牌代表清晰、突破和思维力量。正位时，它暗示思维清晰和在某种情况下的突破。然而，逆位时可能表示困惑、混乱或思维障碍，督促你退后一步重新评估自己的思维和信念。", "source":"宝剑王牌"},
{"id":51, "page_content":"正位解释: 困难的选择、犹豫不决、僵局，逆位解释: 回避选择、否认、僵持，总解释: 宝剑二代表困难的选择、犹豫不决和僵局。正位时，它暗示需要做出困难的决定，并找到摆脱僵局的方法。然而，逆位时可能表示回避选择、否认或陷入僵持，提醒你要面对恐惧并做出选择。", "source":"宝剑二"},
{"id":52, "page_content":"正位解释: 心碎、损失、悲伤，逆位解释: 康复、宽恕、继续前进，总解释: 宝剑三代表心碎、损失和悲伤。正位时，它暗示痛苦的情感体验，需要处理和从中疗愈。然而，逆位时可能表示康复、宽恕和继续前进，提醒你在困难时期之后，疗愈和成长是可能的。", "source":"宝剑三"},
{"id":53, "page_content":"正位解释: 休息、康复、思考，逆位解释: 疲惫、精疲力竭、不安，总解释: 宝剑四代表休息、康复和思考。正位时，它暗示需要休息一下，恢复能量。然而，逆位时可能表示疲惫、精疲力竭或不安，督促你优先考虑自己的心理和身体健康，并在需要时寻求支持。", "source":"宝剑四"},
{"id":54, "page_content":"正位解释: 冲突、失败、背叛，逆位解释: 妥协、宽恕、继续前进，总解释: 宝剑五代表冲突、失败和背叛。正位时，它暗示痛苦的失败，并需要面对和解决这种情况。然而，逆位时可能表示妥协、宽恕和继续前进，提醒你抱怨只会带来更多的痛苦和苦难。", "source":"宝剑五"},
{"id":55, "page_content":"正位解释: 过渡、继续前进、进展，逆位解释: 停滞、延迟、抵制变化，总解释: 宝剑六代表过渡、继续前进和进展。正位时，它暗示走向更美好未来的旅程，离开旧的模式和情境。然而，逆位时可能表示停滞、延迟或抵制变化，督促你审视并克服阻碍你前进的障碍。", "source":"宝剑六"},
{"id":56, "page_content":"正位解释: 欺骗、背叛、偷窃，逆位解释: 坦白、诚实、归还所欠，总解释: 宝剑七代表欺骗、背叛和偷窃。正位时，它暗示需要警惕情况中的可能欺骗或偷窃。然而，逆位时可能表示坦白、诚实和归还所欠，提醒你诚实和正直对于健康的关系和个人成长至关重要。", "source":"宝剑七"},
{"id":57, "page_content":"正位解释: 限制、束缚、焦虑，逆位解释: 自我限制的信念、受害者心态、自我破坏，总解释: 宝剑八代表限制、束缚和焦虑。正位时，它暗示在某种情况下感到被困和无助。然而，逆位时可能表示自我限制的信念、受害者心态或自我破坏，提醒你有能力摆脱限制性信念并掌控自己的生活。", "source":"宝剑八"},
{"id":58, "page_content":"正位解释: 焦虑、恐惧、噩梦，逆位解释: 释放、面对恐惧、寻求支持，总解释: 宝剑九代表焦虑、恐惧和噩梦。正位时，它暗示你可能因为担心和压力而感到不堪重负，通常与你自己的思想和恐惧有关。然而，逆位时可能表示内心的纷扰、过度思考或面对恐惧，提醒你寻求支持，实践自我怜悯，并相信自己内在的力量和韧性。", "source":"宝剑九"},
{"id":59, "page_content":"正位解释: 痛苦的结束、背叛、损失，逆位解释: 康复、释放、新的开始，总解释: 宝剑十代表痛苦的结束、背叛和损失。正位时，它暗示深刻的痛苦和损失感，需要接受并从情况中继续前进。然而，逆位时可能表示康复、释放和新的开始，提醒你即使在最黑暗的时刻，仍然有希望迎接更美好的未来。", "source":"宝剑十"},
{"id":60, "page_content":"正位解释: 好奇心、新思维、热情，逆位解释: 冲动、匆忙、鲁莽，总解释: 宝剑侍从代表好奇心、新思维和热情。正位时，它暗示对知识的渴望和探索新思维和机会的意愿。然而，逆位时可能表示冲动、匆忙或鲁莽，提醒你在采取行动之前放慢节奏并深思熟虑。", "source":"宝剑侍从"},
{"id":61, "page_content":"正位解释: 行动、雄心、决心，逆位解释: 攻击性、冲动、匆忙，总解释: 宝剑骑士代表行动、雄心和决心。正位时，它暗示需要迅速而果断地采取行动以实现目标。然而，逆位时可能表示攻击性、冲动或匆忙，提醒你注意行动的后果，避免不必要的风险。", "source":"宝剑骑士"},
{"id":62, "page_content":"正位解释: 清晰、独立、客观，逆位解释: 冷漠、苦涩、残酷，总解释: 宝剑皇后代表清晰、独立和客观。正位时，它暗示需要以清晰而理性的心态处理情况，并依靠自己的力量和独立性。然而，逆位时可能表示冷漠、苦涩或残酷，提醒你在逻辑思考中要平衡同情心和共感力。", "source":"宝剑皇后"},
{"id":63, "page_content":"正位解释: 权威、领导力、理性，逆位解释: 残忍、操控、滥用权力，总解释: 宝剑国王代表权威、领导力和理性。正位时，它暗示需要掌控局势，并运用逻辑和理性做出决策。然而，逆位时可能表示残忍、操控或滥用权力，提醒你对自己的行为对他人的影响保持警惕，并善用自己的权力。", "source":"宝剑国王"},
{"id":64, "page_content":"正位解释: 新的开始，繁荣，潜力，逆位解释: 错过机会，缺乏，财务挫折，总解释: 星币王牌代表新的开始，繁荣和潜力。正位时，它表示财务增长和丰裕的机会。逆位时，它警示您错过机会，缺乏和潜在的财务挫折。", "source":"星币王牌"},
{"id":65, "page_content":"正位解释: 平衡，适应性，兼顾，逆位解释: 不平衡，不堪重负，不稳定，总解释: 星币二象征平衡，适应性和兼顾多个优先事项。正位时，它表示能够处理多项任务并找到和谐。逆位时，它警示您在管理责任时出现不平衡，不堪重负和不稳定的情况。", "source":"星币二"},
{"id":66, "page_content":"正位解释: 团队合作，协作，技能，逆位解释: 缺乏合作，平庸，技能不足，总解释: 星币三代表团队合作，协作和磨练的技能。正位时，它表示成功的合作和对专业知识的认可。逆位时，它警示缺乏合作，平庸和技能或工艺不足的问题。", "source":"星币三"},
{"id":67, "page_content":"正位解释: 稳定，安全，财产，逆位解释: 财务不安全，贪婪，固执，总解释: 星币四代表稳定，安全和财产。正位时，它表示财务稳定和对资源的务实处理。逆位时，它警示财务不安全，贪婪和固守财产或贫乏心态的问题。", "source":"星币四"},
{"id":68, "page_content":"正位解释: 财务困难，贫困，孤立，逆位解释: 康复，希望，支持，总解释: 星币五代表财务困难，贫困和孤立。正位时，它表示困难时期和需要帮助。逆位时，它象征康复，希望和在困难情况下获得支持的可能性。", "source":"星币五"},
{"id":69, "page_content":"正位解释: 慷慨，慈善，资源共享，逆位解释: 自私，贪婪，不公平，总解释: 星币六象征慷慨，慈善和资源共享的行为。正位时，它代表愿意给予和帮助他人。逆位时，它警示我们要避免自私，贪婪和不公平，提醒我们在互动中要保持公平和平衡。", "source":"星币六"},
{"id":70, "page_content":"正位解释: 评估，耐心，投资，逆位解释: 不耐烦，进展不顺，投资不佳，总解释: 星币七代表评估，耐心和投资。正位时，它建议我们需要回顾进展，保持耐心，并相信过程。逆位时，它警示我们要避免不耐烦，进展不顺或进行糟糕的投资。", "source":"星币七"},
{"id":71, "page_content":"正位解释: 奉献，技能发展，精通，逆位解释: 注意力分散，平庸，重复，总解释: 星币八象征奉献，技能发展和精通。正位时，它表示专注的努力，致力于提高技能和达到精通。逆位时，它警示我们要避免注意力分散，平庸或陷入重复性的任务中。", "source":"星币八"},
{"id":72, "page_content":"正位解释: 丰裕，自给自足，奢侈，逆位解释: 经济依赖，自尊问题，过度物质主义，总解释: 星币九代表丰裕，自给自足和奢侈。正位时，它表示享受劳动的成果，经济独立和成就感。逆位时，它警示我们要避免经济依赖，自尊问题或过度的物质主义。", "source":"星币九"},
{"id":73, "page_content":"正位解释: 财富，家庭，遗产，逆位解释: 经济损失，家庭纷争，缺乏稳定，总解释: 星币十象征财富，家庭和遗产。正位时，它表示经济稳定，家庭关系和代际目标的实现。逆位时，它警示我们要避免经济损失，家庭纷争或家庭事务的不稳定。", "source":"星币十"},
{"id":74, "page_content":"正位解释: 抱负，学习，实现，逆位解释: 缺乏抱负，不行动，缺乏专注，总解释: 星币Page代表抱负，学习和实现的可能性。正位时，它表示追求新机会，渴望知识和实现目标的潜力。逆位时，它警示我们要避免缺乏抱负，不行动或对目标缺乏专注。", "source":"星币侍从"},
{"id":75, "page_content":"正位解释: 责任，努力，可靠性，逆位解释: 懒惰，拖延，缺乏进展，总解释: 星币骑士象征责任，努力和可靠性。正位时，它代表勤奋，毅力和朝着目标的有条不紊的进展。逆位时，它警示我们要避免懒惰，拖延或由于缺乏承诺而缺乏进展。", "source":"星币骑士"},
{"id":76, "page_content":"正位解释: 培育，丰富，实用主义，逆位解释: 自我疏忽，经济不稳定，过度依赖，总解释: 星币皇后代表培育，丰富和实用主义。正位时，它表示培育他人，经济稳定和实际生活方式。逆位时，它警示我们要避免忽视自我保健，经济不稳定或过度依赖他人。", "source":"星币皇后"},
{"id":77, "page_content":"正位解释: 繁荣，安全，领导力，逆位解释: 经济不稳定，贪婪，滥用权力，总解释: 星币国王代表繁荣，安全和领导力。正位时，它表示经济稳定，明智的领导和对财富的负责任态度。逆位时，它警示我们要避免经济不稳定，贪婪或滥用权力。", "source":"星币国王"}
]

_ = load_dotenv(find_dotenv())
"""
embeddings = BaichuanTextEmbeddings(baichuan_api_key=os.environ["BAICHUAN_API_KEY"])
 #向量库
vectorstore = Chroma.from_documents(
    documents,
    embedding=embeddings,
)

retriever = vectorstore.as_retriever(
    search_type="similarity",
    search_kwargs={"k": 1},
) # select top result
 """
llm = ChatOpenAI(
    base_url="http://api.baichuan-ai.com/v1",
    api_key=os.environ["BAICHUAN_API_KEY"],
    model="Baichuan4",
)

""" 
contextualize_q_system_prompt = (
    "根据聊天记录及用户最新的问题"
    "该问题可能涉及聊天记录中的上下文信息，重新构思一个独立的问题，"
    "使其能够在不参考聊天历史的情况下被理解。"
    "不要直接回答问题，而是在需要时对其进行重新表述，否则直接按原样返回问题。"
)

contextualize_q_prompt = ChatPromptTemplate.from_messages([
    ("system",contextualize_q_system_prompt),
    MessagesPlaceholder("chat_history"),
    ("human","{input}")
])
history_aware_retriever = create_history_aware_retriever(llm,retriever,contextualize_q_prompt) """

### 回答问题 ###
qa_prompt = ChatPromptTemplate.from_messages([
    ("system",'''你要根据抽的牌的结果来描述，包括这张牌是什么牌（source），这张牌预示着什么（page_content）。
     你的回答应该以“下面由我为您抽牌，抽到的牌是”作为开头。接着你要指明这张牌是正位还是逆位，如果是正位，则选择正位相关的内容进行解释；
     如果是逆位，则选择逆位相关的内容进行解释。
                '''),
    MessagesPlaceholder("chat_history"),
    ("human","{input}")
])
#question_answer_chain = create_stuff_documents_chain(llm,qa_prompt)
#chat_chain = create_retrieval_chain(history_aware_retriever,question_answer_chain)

chat_chain = qa_prompt | llm

chain = RunnableWithMessageHistory(
    chat_chain,
    get_session_history,
    input_messages_key="input",
    history_messages_key="chat_history"
)

config = {
    "configurable":{
        "session_id":time.time(),
    }
}

def select_a_card(question):
    if question=="开始测试":
        random.shuffle(documents)
        random_index = secrets.randbelow(78)
        random_element = documents[random_index]
        response = chain.invoke( {"input":str(random_element)},config=config)
        return response
question="开始测试"
#print(select_a_card(question)) 


